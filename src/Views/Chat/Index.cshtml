@{
    ViewData["Title"] = "AI Chat Assistant";
}

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-robot"></i> AI Chat Assistant
                </h4>
                <small>Powered by Azure OpenAI</small>
            </div>
            <div class="card-body">
                <!-- Chat History Display Area -->
                <div id="chatHistory" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                        <p class="mt-2">Start a conversation with the AI assistant!</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-group">
                    <textarea id="userMessage" 
                              class="form-control" 
                              rows="3" 
                              placeholder="Type your message here..."
                              maxlength="1000"></textarea>
                    <button id="sendButton" class="btn btn-primary" type="button">
                        <i class="bi bi-send"></i> Send
                    </button>
                </div>
                <small class="text-muted">Press Ctrl+Enter to send</small>

                <!-- Error Alert (hidden by default) -->
                <div id="errorAlert" class="alert alert-danger mt-3" style="display: none;" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span id="errorMessage"></span>
                </div>

                <!-- Action Buttons -->
                <div class="mt-3">
                    <button id="clearButton" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-trash"></i> Clear History
                    </button>
                </div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-info-circle"></i> About this Chat</h6>
                <p class="card-text small">
                    This chat assistant uses Azure OpenAI to help answer your questions about Zava Storefront products and services.
                    Your conversations are logged for quality and monitoring purposes.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // DOM Elements
        const chatHistory = document.getElementById('chatHistory');
        const userMessageInput = document.getElementById('userMessage');
        const sendButton = document.getElementById('sendButton');
        const clearButton = document.getElementById('clearButton');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');

        // Initialize chat history from session storage
        let messages = JSON.parse(sessionStorage.getItem('chatHistory')) || [];
        renderChatHistory();

        // Send message on button click
        sendButton.addEventListener('click', sendMessage);

        // Send message on Ctrl+Enter
        userMessageInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                sendMessage();
            }
        });

        // Clear chat history
        clearButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                messages = [];
                sessionStorage.removeItem('chatHistory');
                renderChatHistory();
            }
        });

        // Send message function
        async function sendMessage() {
            const message = userMessageInput.value.trim();
            
            if (!message) {
                showError('Please enter a message');
                return;
            }

            // Disable input while processing
            setInputState(false);
            hideError();

            // Add user message to chat
            addMessage('user', message);
            userMessageInput.value = '';

            // Show loading indicator
            const loadingId = addMessage('assistant', '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Thinking...');

            try {
                // Send request to server
                const response = await fetch('/Chat/SendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get response');
                }

                const data = await response.json();
                
                // Remove loading message
                removeMessage(loadingId);
                
                // Add AI response
                addMessage('assistant', data.response);

            } catch (error) {
                console.error('Error:', error);
                removeMessage(loadingId);
                showError(error.message || 'Failed to send message. Please try again.');
            } finally {
                setInputState(true);
                userMessageInput.focus();
            }
        }

        // Add message to chat history
        function addMessage(role, content) {
            const messageId = Date.now();
            const message = { id: messageId, role: role, content: content, timestamp: new Date().toISOString() };
            messages.push(message);
            sessionStorage.setItem('chatHistory', JSON.stringify(messages));
            renderChatHistory();
            return messageId;
        }

        // Remove message from chat history
        function removeMessage(messageId) {
            messages = messages.filter(m => m.id !== messageId);
            sessionStorage.setItem('chatHistory', JSON.stringify(messages));
            renderChatHistory();
        }

        // Render chat history
        function renderChatHistory() {
            if (messages.length === 0) {
                chatHistory.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                        <p class="mt-2">Start a conversation with the AI assistant!</p>
                    </div>
                `;
                return;
            }

            chatHistory.innerHTML = messages.map(msg => {
                const isUser = msg.role === 'user';
                const bgColor = isUser ? 'bg-primary text-white' : 'bg-light';
                const alignment = isUser ? 'text-end' : 'text-start';
                const icon = isUser ? '<i class="bi bi-person-circle"></i>' : '<i class="bi bi-robot"></i>';
                const time = new Date(msg.timestamp).toLocaleTimeString();
                
                return `
                    <div class="${alignment} mb-3">
                        <div class="d-inline-block ${bgColor} rounded p-3" style="max-width: 80%;">
                            <div class="small mb-1"><strong>${icon} ${isUser ? 'You' : 'AI Assistant'}</strong></div>
                            <div>${msg.content}</div>
                            <div class="small opacity-75 mt-1">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Set input state (enabled/disabled)
        function setInputState(enabled) {
            userMessageInput.disabled = !enabled;
            sendButton.disabled = !enabled;
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';
            setTimeout(() => hideError(), 5000);
        }

        // Hide error message
        function hideError() {
            errorAlert.style.display = 'none';
        }

        // Focus on input on page load
        userMessageInput.focus();
    </script>
}
